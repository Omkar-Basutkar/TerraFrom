provider "aws" {
  region     = "ap-south-1"
  access_key = ""
  secret_key = ""
}


resource "aws_instance" "wordpress_instance" {
  ami           = "ami-0d81306eddc614a45"
  instance_type = "t2.micro"

  key_name = aws_key_pair.tf-key-pair.key_name

  tags = {
    Name = "WordPress Instance"
  }
 user_data = <<-EOF
              #!/bin/bash
              sudo yum update -y
              sudo amazon-linux-extras install -y lamp-mariadb10.2-php7.2 php7.2
              sudo yum install -y httpd mariadb-server

              sudo systemctl start httpd
              sudo systemctl enable httpd

              sudo systemctl start mariadb
              sudo systemctl enable mariadb

              # Secure MySQL installation (provide root password when prompted)
              sudo mysql_secure_installation

              # Download and install WordPress
              sudo yum install -y php-gd
              sudo systemctl restart httpd
              sudo wget https://wordpress.org/latest.tar.gz -P /var/www/html
              sudo tar -xzf /var/www/html/latest.tar.gz -C /var/www/html
              sudo mv /var/www/html/wordpress/* /var/www/html/
              sudo chown -R apache:apache /var/www/html/
              EOF
}

resource "aws_key_pair" "tf-key-pair" {
  key_name   = "tf-key"
  public_key = tls_private_key.rsa.public_key_openssh
}
resource "tls_private_key" "rsa" {
  algorithm = "RSA"
  rsa_bits  = 4096
}
resource "local_file" "tf-key" {
  content  = tls_private_key.rsa.private_key_pem
  filename = "tf-key-pair"
}

resource "aws_db_instance" "wordpress_db" {
  allocated_storage    = 20
  storage_type         = "gp2"
  engine               = "mysql"
  engine_version       = "5.7"
  instance_class       = "db.t2.micro"
  username             = "admin"
  password             = "password"
  parameter_group_name = "default.mysql5.7"
}

output "instance_ip" {
  value = aws_instance.wordpress_instance.public_ip
}

output "database_endpoint" {
  value = aws_db_instance.wordpress_db.endpoint
}
